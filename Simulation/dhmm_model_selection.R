suppressMessages({
  library(doMPI)
  library(foreach)
})
#library(doMC)

nrun=1000

sim_each <- function(no.run, seed = 2256,burnin = 3000, nsim. = 5000){
  
  source("DHMM_v1.R",local=T)
  #source('utils.R',local=T)
  set.seed(seed + no.run);
  daf <- genSim(N = 390, rx. = rep(c(0,1),each = 390/2),fitRx = c(FALSE,TRUE,FALSE));

  pars_hs2 <- c(0.932,
                0.426,0.024,
                0.953,0.024,
                0.977,0.048,
                34.082,-3.257,3.366,-0.238,
                38.430,-5.149,3.318,-0.160,
                13.425,0.051,0.684,-0.027,0.051,0.025,0.033,0.010,0.684,0.033,13.190,0.086,-0.027,0.010,0.086,0.028,
                0.2, 0.443, 20, 145.159,
                0.2,0.252, 30, 62.988,
                0.512,0.042)

  pars_hs4 <- c(0.495,0.218,0.218,
                0.190,0.190,0.047,0.029,0.233,0.506,0.029,0.233,0.506,0.010,0.007,0.007,
                0.531,0.051,0.051,0.025,0.216,0.372,0.372,0.126,0.216,0.372,0.372,0.126,
                0.740,0.021,0.021,0.015,0.119,0.471,0.471,0.012,0.119,0.471,0.471,0.012,
                34.082,0.206,0.206,-3.669,3.366,-0.072,-0.072,0.095,
                38.430,-0.961,-0.961,-3.227,3.318,-0.049,-0.049,-0.063,
                13.425,0.051,0.684,-0.027,0.051,0.025,0.033,0.010,0.684,0.033,13.190,0.086,-0.027,0.010,0.086,0.028,
                0.048, 0.436, 0.436, 0.443, 8.911, 75.614, 75.614, 145.159,
                0.139, 0.333, 0.333, 0.252, 19.069, 135.208, 135.208, 62.988,
                0.233,0.233,0.048,0.026,0.325,0.323,0.026,0.325,0.323,0.020,0.011,0.011)

  pars_hs5 <- c(0.248,0.247,0.218,0.219, 
                0.287,0.190,0.190,0.047,0.287,0.190,0.190,0.047,0.015,0.014,0.233,0.506,0.015,0.014,0.233,0.506,0.005,0.005,0.007,0.007,
                0.267,0.266,0.025,0.025,0.025,0.267,0.266,0.025,0.025,0.025,0.216,0.216,0.372,0.372,0.126,0.216,0.216,0.372,0.372,0.126,
                0.370,0.370,0.021,0.021,0.015,0.370,0.370,0.021,0.021,0.015,0.059,0.060,0.471,0.471,0.012,0.059,0.060,0.471,0.471,0.012,
                33.776,0.206,0.206,0.206,-3.669,3.438,-0.072,-0.072,-0.072,0.095,
                39.391,-0.961,-0.961,-0.961,-3.227,3.367,-0.049,-0.049,-0.049,-0.063,
                13.425,0.051,0.684,-0.027,0.051,0.025,0.033,0.010,0.684,0.033,13.190,0.086,-0.027,0.010,0.086,0.028,
                0.048, 0.048, 0.436, 0.436, 0.443, 8.911, 8.911, 75.614, 75.614, 145.159,
                0.139, 0.139, 0.333, 0.333, 0.252, 19.069, 19.069, 135.208, 135.208, 62.988,
                0.265,0.233,0.233,0.048,0.265,0.233,0.233,0.048,0.013,0.013,0.325,0.323,0.013,0.013,0.325,0.323,0.010,0.010,0.011,0.011)

  x_hs2 <- simulated(y = daf$y, inits.= pars_hs2, nsim.= nsim., burnin = burnin, ksamp.= 1, Km = c(2,2), hs = c(2,2,2),
                 N.=daf$N, ni.=daf$ni, rx. = daf$rx, fitRx = daf$fitRx, report1.=1000,id=rep(1:daf$N,5),run. = no.run)
  x <- simulated(y = daf$y, inits. = c(daf$pars), nsim.= nsim., burnin = burnin, ksamp.= 1, Km = c(2,2), hs = c(3,3,3),
                 N.=daf$N, ni.=daf$ni, rx. = daf$rx, fitRx = daf$fitRx, report1.=1000,id=rep(1:daf$N,5),run. = no.run)
  x_hs4 <- simulated(y = daf$y, inits. = pars_hs4, nsim.= nsim., burnin = burnin, ksamp.= 1, Km = c(2,2), hs = c(4,4,4),
                 N.=daf$N, ni.=daf$ni, rx. = daf$rx, fitRx = daf$fitRx, report1.=1000,id=rep(1:daf$N,5),run. = no.run)
  x_hs5 <- simulated(y = daf$y, inits. = pars_hs5, nsim.= nsim., burnin = burnin, ksamp.= 1, Km = c(2,2), hs = c(5,5,5),
                 N.=daf$N, ni.=daf$ni, rx. = daf$rx, fitRx = daf$fitRx, report1.=1000,id=rep(1:daf$N,5),run. = no.run)
  WAIC = c(x_hs2$WAIC, x$WAIC, x_hs4$WAIC, x_hs5$WAIC)
  return(WAIC)
}


cl <- doMPI::startMPIcluster()
registerDoMPI(cl)
out <- foreach(i = 1: nrun,.combine="rbind",.multicombine=T,.errorhandling="pass")%dopar%{
  sim_each(i)
}
save('out',file=paste0("dhmm_hs_sel",nrun,".Rdata"))
stopCluster(cl)
mpi.exit()
